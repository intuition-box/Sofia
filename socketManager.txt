/**
 * Utility functions for managing channels in test scenarios
 */

import { config } from '../config';

export interface ChannelInfo {
  id: string;
  name: string;
  type: number;
  metadata?: Record<string, any>;
}

/**
 * Create or get a test channel for benchmarking
 */
export async function createTestChannel(
  apiUrl: string,
  userId: string,
  agentId: string
): Promise<ChannelInfo | null> {
  try {
    const baseUrl = apiUrl.replace('ws://', 'http://').replace('wss://', 'https://');

    console.log('[ChannelUtils] Creating test channel...');
    console.log(`  User ID: ${userId}`);
    console.log(`  Agent ID: ${agentId}`);

    const requestBody = {
      name: `test-dm-${Date.now()}`,
      type: 2, // ChannelType.DM
      server_id: '00000000-0000-0000-0000-000000000000',
      participantCentralUserIds: [userId, agentId],
      metadata: {
        isDm: true,
        user1: userId,
        user2: agentId,
        forAgent: agentId,
        testChannel: true,
        createdAt: new Date().toISOString(),
      },
    };

    console.log(`[ChannelUtils] Request body:`, JSON.stringify(requestBody, null, 2));

    // Try to create a DM-style channel with both participants
    const createResponse = await fetch(`${baseUrl}/api/messaging/central-channels`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestBody),
    });

    const responseText = await createResponse.text();
    console.log(`[ChannelUtils] Create response (${createResponse.status}): ${responseText}`);

    if (createResponse.ok) {
      try {
        const channel = JSON.parse(responseText);
        if (channel && channel.id) {
          console.log(`[ChannelUtils] ✅ Created channel: ${channel.id}`);
          return channel;
        } else if (channel && channel.data && channel.data.id) {
          // Sometimes the response is wrapped in a data property
          console.log(`[ChannelUtils] ✅ Created channel: ${channel.data.id}`);
          return channel.data;
        } else {
          console.error('[ChannelUtils] Created channel but no ID in response');
          return null;
        }
      } catch (parseError) {
        console.error('[ChannelUtils] Failed to parse create response:', parseError);
        return null;
      }
    } else {
      console.error(`[ChannelUtils] Failed to create channel: ${createResponse.status}`);
      return null;
    }
  } catch (error) {
    console.error('[ChannelUtils] Error creating channel:', error);
    return null;
  }
}

/**
 * Get or create a DM channel between two users
 */
export async function getOrCreateDmChannel(
  apiUrl: string,
  userId: string,
  agentId: string
): Promise<ChannelInfo | null> {
  try {
    const baseUrl = apiUrl.replace('ws://', 'http://').replace('wss://', 'https://');

    // First try to get existing DM channel
    const params = new URLSearchParams({
      currentUserId: userId,
      targetUserId: agentId,
      dmServerId: '00000000-0000-0000-0000-000000000000',
    });

    console.log('[ChannelUtils] Checking for existing DM channel...');
    console.log(`  URL: ${baseUrl}/api/messaging/dm-channel?${params}`);

    const getResponse = await fetch(`${baseUrl}/api/messaging/dm-channel?${params}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (getResponse.ok) {
      const responseText = await getResponse.text();
      console.log(`[ChannelUtils] DM channel response: ${responseText}`);

      try {
        const response = JSON.parse(responseText);

        // Check if response has data wrapper (API response format)
        if (response && response.success && response.data && response.data.id) {
          const channel = response.data;
          console.log(`[ChannelUtils] ✅ Found existing DM channel: ${channel.id}`);
          return channel;
        } else if (response && response.id) {
          // Direct channel object
          console.log(`[ChannelUtils] ✅ Found existing DM channel: ${response.id}`);
          return response;
        } else {
          console.log('[ChannelUtils] ⚠️ Response missing channel ID, creating new channel');
        }
      } catch (parseError) {
        console.error('[ChannelUtils] Failed to parse response:', parseError);
      }
    } else {
      const errorText = await getResponse.text();
      console.log(`[ChannelUtils] DM channel not found (${getResponse.status}): ${errorText}`);
    }

    // If not found or invalid, create a new one
    console.log('[ChannelUtils] Creating new channel...');
    return await createTestChannel(apiUrl, userId, agentId);
  } catch (error) {
    console.error('[ChannelUtils] Error getting/creating DM channel:', error);
    return null;
  }
}

/**
 * Add an agent to an existing channel
 */
export async function addAgentToChannel(
  apiUrl: string,
  channelId: string,
  agentId: string
): Promise<boolean> {
  try {
    const baseUrl = apiUrl.replace('ws://', 'http://').replace('wss://', 'https://');

    console.log(`[ChannelUtils] Adding agent ${agentId} to channel ${channelId}...`);

    const response = await fetch(`${baseUrl}/api/messaging/central-channels/${channelId}/agents`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        agentId: agentId,
      }),
    });

    if (response.ok) {
      console.log(`[ChannelUtils] ✅ Successfully added agent to channel`);
      return true;
    } else {
      const errorText = await response.text();
      console.warn(`[ChannelUtils] Could not add agent: ${response.status} ${errorText}`);
      // This might not be fatal - agent could already be in channel
      return response.status === 409; // Conflict = already exists
    }
  } catch (error) {
    console.error('[ChannelUtils] Error adding agent to channel:', error);
    return false;
  }
}

/**
 * Ensure a channel exists and has the agent as a participant
 */
export async function ensureChannelWithAgent(
  apiUrl: string,
  userId: string,
  agentId: string
): Promise<ChannelInfo | null> {
  // Get or create the channel
  const channel = await getOrCreateDmChannel(apiUrl, userId, agentId);

  if (channel) {
    // Try to add the agent (might already be added)
    await addAgentToChannel(apiUrl, channel.id, agentId);
    return channel;
  }

  return null;
}

// Note: Message sending is handled via Socket.IO in the socket-client.ts
// The API is only used for channel creation and participant management