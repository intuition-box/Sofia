#!/bin/bash

# DÃ©gradÃ© de rouge (code 196) Ã  jaune (code 226)
colors=(196 202 208 214 220 226 226 226 226)

# Lire le logo depuis un here document
mapfile -t ascii_art << 'EOF'
_____/\\\\\\\\\\\________________________/\\\\\______________________________
____/\\\/////////\\\____________________/\\\///______________________________
____\//\\\______\///____________________/\\\_______/\\\______________________
______\////\\\_____________/\\\\\_____/\\\\\\\\\___\///___/\\\\\\\\\_________
__________\////\\\________/\\\///\\\__\////\\\//_____/\\\_\////////\\\_______
______________\////\\\____/\\\__\//\\\____\/\\\______\/\\\___/\\\\\\\\\\_____
________/\\\______\//\\\__\//\\\__/\\\_____\/\\\______\/\\\__/\\\/////\\\____
________\///\\\\\\\\\\\/____\///\\\\\/______\/\\\______\/\\\_\//\\\\\\\\/\\__
___________\///////////________\/////________\///_______\///___\////////\//__
EOF

# Appliquer le gradient ligne par ligne
for i in "${!ascii_art[@]}"; do
    color=${colors[i % ${#colors[@]}]}
    printf "\e[38;5;%sm%s\e[0m\n" "$color" "${ascii_art[$i]}"
done


# Fonction pour lancer une application avec des logs simplifiÃ©s
launch_app() {
    local app_name="$1"
    local directory="$2"
    local command="$3"
    local log_icon="$4"
    local current_dir=$(pwd)
    
    echo "${log_icon} Lancement de ${app_name}..."
    cd "${directory}" || { echo "âŒ Erreur: Dossier ${directory} introuvable"; return 1; }
    
    # Lancer l'application en arriÃ¨re-plan sans afficher tous les logs
    eval "${command}" > /dev/null 2>&1 &
    local pid=$!
    
    # Revenir au dossier initial
    cd "${current_dir}"
    
    # VÃ©rifier si le processus dÃ©marre correctement
    sleep 1
    if kill -0 "$pid" 2>/dev/null; then
        echo "âœ… ${app_name} dÃ©marrÃ© avec succÃ¨s (PID: $pid)"
    else
        echo "âŒ ${app_name} a Ã©chouÃ© au dÃ©marrage"
    fi
}

# VÃ©rifier si l'argument "start" est fourni
if [ "$1" = "start" ]; then
    echo "ğŸš€ DÃ©marrage de SofIA..."
    echo ""
    
    # VÃ©rifier et tuer les processus sur le port 3001
    echo "ğŸ” VÃ©rification du port 3001..."
    if lsof -ti:3001 > /dev/null 2>&1; then
        echo "âš ï¸  Port 3001 occupÃ©, arrÃªt des processus..."
        pkill -f "PORT=3001" || true
        sleep 2
    fi
    
    # Lancer le serveur MCP (depuis core)
    launch_app "MCP Server" "../intuition-mcp-server" "pnpm run start:http" "ğŸ›œ"
    
    # Attendre un peu avant de lancer le suivant
    sleep 2
    
    # Lancer ElizaOS (depuis core)
    launch_app "ElizaOS" "SofIA/agent1" "elizaos start" "ğŸ’"
    
    # Attendre un peu avant de lancer le suivant
    sleep 2
    
    # Activer l'agent (depuis core)
    launch_app "Agent Activation" "SofIA/agent1" "elizaos agent start --path SofIA.json" "ğŸ¤–"
    
    # Attendre un peu avant de lancer le suivant
    sleep 2
    
    # Lancer le build de l'extension (depuis core) - en mode visible
    echo "ğŸ“± Lancement du build de l'extension..."
    cd "SofIA/extension" || { echo "âŒ Erreur: Dossier SofIA/extension introuvable"; exit 1; }
    
    # Lancer le build en mode visible pour voir le progrÃ¨s
    if npm run build; then
        echo "âœ… Extension build terminÃ© avec succÃ¨s"
    else
        echo "âŒ Extension build a Ã©chouÃ©"
    fi
    
    # Revenir au dossier initial
    cd "../../"
    
    echo ""
    echo "âœ… Toutes les applications ont Ã©tÃ© lancÃ©es!"
    echo "ğŸ“ Pour arrÃªter toutes les applications, utilisez Ctrl+C"
    echo ""
    
    # Attendre que toutes les tÃ¢ches de fond se terminent
    wait
else
    echo "Usage: ./sofia start"
    echo "Ce script lance toutes les applications SofIA en parallÃ¨le."
fi